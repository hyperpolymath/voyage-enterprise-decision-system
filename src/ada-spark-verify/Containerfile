# VEDS SPARK Verification Service
# Multi-stage build for minimal runtime image

FROM ghcr.io/alire-project/alire:latest AS builder

WORKDIR /build

# Copy project files
COPY veds_verify.gpr .
COPY src/ src/

# Build with GNAT
RUN alr init --in-place -n veds_verify && \
    alr build --release

# Run SPARK proofs (optional, can be slow)
# RUN gnatprove -P veds_verify.gpr --level=2 --report=all

# Create minimal runtime image
FROM cgr.dev/chainguard/wolfi-base:bookworm-slim

WORKDIR /app

# Install runtime dependencies
RUN apt-get update && apk add --no-cache -y \
    libgnat-12 \
    && rm -rf /var/lib/apt/lists/*

# Copy built binary
COPY --from=builder /build/bin/veds_verify /app/veds_verify

# Copy shared library for FFI (when built as library)
# COPY --from=builder /build/lib/libveds_verify.so /app/lib/

# Health check
HEALTHCHECK --interval=30s --timeout=5s --start-period=5s --retries=3 \
    CMD /app/veds_verify --health || exit 1

# Run verification tests
CMD ["/app/veds_verify"]
