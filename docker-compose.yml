version: '3.8'

# VEDS MVP Development Environment
# Narrowed stack: SurrealDB + Dragonfly + Rust + Deno
# Start with: docker-compose up -d

services:
  # ===========================================================================
  # MVP CORE: 2 Databases
  # ===========================================================================

  # SurrealDB - Primary database (graph + document + SQL)
  # Handles: transport network, shipments, routes, constraints, audit
  surrealdb:
    image: surrealdb/surrealdb:v1.5.4
    container_name: veds-surrealdb
    ports:
      - "8000:8000"
    volumes:
      - surreal_data:/data
    command: start --log info --user root --pass veds_dev_password file:/data/veds.db
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - veds-network

  # Dragonfly - Redis-compatible cache for hot data
  # Handles: real-time positions, rate quotes, session data
  dragonfly:
    image: docker.dragonflydb.io/dragonflydb/dragonfly:v1.15.1
    container_name: veds-dragonfly
    ports:
      - "6379:6379"
    volumes:
      - dragonfly_data:/data
    ulimits:
      memlock: -1
    command: dragonfly --requirepass veds_dev_password --maxmemory 512mb
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "veds_dev_password", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - veds-network

  # ===========================================================================
  # MVP CORE: 2 Application Services
  # ===========================================================================

  # Rust Route Optimizer (gRPC + metrics)
  rust-optimizer:
    build:
      context: ./src/rust-routing
      dockerfile: Dockerfile
    container_name: veds-optimizer
    ports:
      - "50051:50051"   # gRPC
      - "8090:8090"     # HTTP metrics
    environment:
      - RUST_LOG=info
      - SURREALDB_URL=ws://surrealdb:8000
      - SURREALDB_USER=root
      - SURREALDB_PASS=veds_dev_password
      - DRAGONFLY_URL=redis://dragonfly:6379
      - DRAGONFLY_PASS=veds_dev_password
    depends_on:
      surrealdb:
        condition: service_healthy
      dragonfly:
        condition: service_healthy
    networks:
      - veds-network

  # Deno API Gateway (REST)
  deno-api:
    build:
      context: ./src/deno-api
      dockerfile: Dockerfile
    container_name: veds-api
    ports:
      - "4000:4000"
    environment:
      - PORT=4000
      - HOST=0.0.0.0
      - SURREALDB_URL=ws://surrealdb:8000
      - SURREALDB_USER=root
      - SURREALDB_PASS=veds_dev_password
      - DRAGONFLY_URL=redis://dragonfly:6379
      - DRAGONFLY_PASS=veds_dev_password
      - OPTIMIZER_URL=http://rust-optimizer:50051
    depends_on:
      surrealdb:
        condition: service_healthy
      dragonfly:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4000/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - veds-network

  # ===========================================================================
  # DEFERRED TO V2 (profiles)
  # ===========================================================================

  # XTDB - Bitemporal database (deferred - using SurrealDB valid_from/until)
  xtdb:
    image: ghcr.io/xtdb/xtdb:2.0.0-beta7
    container_name: veds-xtdb
    ports:
      - "3000:3000"
    volumes:
      - xtdb_data:/var/lib/xtdb
      - ./config/xtdb.yaml:/etc/xtdb.yaml:ro
    environment:
      - XTDB_NODE_DIR=/var/lib/xtdb
    profiles:
      - v2
    networks:
      - veds-network

  # Julia Analytics (deferred - resource intensive)
  julia-viz:
    build:
      context: ./src/julia-viz
      dockerfile: Dockerfile
    container_name: veds-viz
    ports:
      - "8081:8080"
    environment:
      - JULIA_NUM_THREADS=auto
      - SURREALDB_URL=ws://surrealdb:8000
      - DRAGONFLY_URL=redis://dragonfly:6379
    profiles:
      - v2
    networks:
      - veds-network

  # Database admin UI (dev tools)
  adminer:
    image: adminer:latest
    container_name: veds-adminer
    ports:
      - "8082:8080"
    profiles:
      - tools
    networks:
      - veds-network

networks:
  veds-network:
    driver: bridge

volumes:
  surreal_data:
  dragonfly_data:
  xtdb_data:
